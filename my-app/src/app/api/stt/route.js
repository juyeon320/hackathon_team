import { OpenAI } from "openai";
import fs from "fs";
import path from "path";
import { NextResponse } from "next/server";
import { execSync } from "child_process"; // FFmpeg ì‹¤í–‰ì„ ìœ„í•œ ëª¨ë“ˆ ì¶”ê°€

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

const ELEVENLABS_API_KEY = process.env.ELEVENLABS_API_KEY;
const VOICE_ID = "Xb7hH8MSUJpSbSDYk0k2"; // ElevenLabsì—ì„œ ì‚¬ìš©í•  ìŒì„± ID
const MAX_DURATION = 5; // ìµœëŒ€ í—ˆìš© ë…¹ìŒ ê¸¸ì´ (ì´ˆ)

const commonPrompt = {
  "restaurant":`ë„ˆëŠ” ì¤‘êµ­ì§‘ 'ìš©ê¶ë°˜ì 'ì˜ ì‚¬ì¥ì´ë‹¤.  
20ë…„ ì „í†µì˜ ê°€ê²Œì´ë©°, ì¸ê¸° ë©”ë‰´ëŠ” ì§œì¥ë©´, ì§¬ë½•, íƒ•ìˆ˜ìœ¡ì´ë‹¤.  
ê³ ê°ì˜ ì§ˆë¬¸ì´ ì• ë§¤í•˜ë©´ ë˜ë¬¼ì–´ë¼.  
ê³ ê°ì˜ ìš”ì²­ì´ í•©ë‹¹í•˜ë©´ ì²˜ë¦¬í•˜ê³ , ë¶€ë‹¹í•˜ë©´ ì •ì¤‘íˆ ê±°ì ˆí•˜ë¼.  
ë¬´ì¡°ê±´ ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ë¼.`,
"hospital":`ë„ˆëŠ” í—¤ì¡°ë³‘ì›ì˜ ì „í™” ì‘ëŒ€ ë‹´ë‹¹ ì§ì›ì´ë‹¤.
ë³‘ì› ìœ„ì¹˜ëŠ” ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì´ë„ì´ë™ 1921ì´ë‹¤.
ë³‘ì›ì˜ ì„œë¹„ìŠ¤ ê°œì„ ì„ ìœ„í•´ ì •í™•ì„±, ì‹ ì†ì„±ì„ ì¤€ìˆ˜í•´ì•¼ í•œë‹¤.
í™˜ìì˜ ë¬¸ì˜ ë‚´ìš©ì´ ëª…í™•í•˜ì§€ ì•Šë‹¤ë©´ ì¶”ê°€ ì§ˆë¬¸ì„ í†µí•´ ì •í™•íˆ íŒŒì•…í•œ í›„ ì‘ëŒ€í•´ì•¼ í•œë‹¤.
`
}
// ë³‘ì› ì „í™” ì‘ëŒ€ì˜ ê³µí†µ ì‚¬í•­

// ğŸ”¹ ì„±ê²© ìœ í˜•ë³„ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì„¤ì • (ëª…í™•í•˜ê²Œ ë³€ê²½)
const personalityPrompts = {
  restaurant: {
    low: `${commonPrompt.restaurant}
      ## ìŠ¤íƒ€ì¼
    - ì˜ˆì˜ ë°”ë¦„
    - ì¹œì ˆí•œ ì‘ëŒ€.  
    - ê°ì •ì„ ê³µê°.
    - ìš”ì²­ì„ ìµœëŒ€í•œ ìˆ˜ìš©. 
    - ë³´ìƒ ì œì‹œ. 

    ## ëª©í‘œ
    - ê³ ê°ì˜ ë¶ˆë§Œì„ ì ê·¹ì ìœ¼ë¡œ í•´ê²°í•œë‹¤.  
    - ê³ ê°ì—ê²Œ ì¶”ê°€ í˜œíƒì„ ê³ ë ¤í•œë‹¤.  

    ## ì˜ˆì‹œ
    - **ì£¼ë¬¸ ìš”ì²­**
    - ê³ ê°: "ì§œì¥ë©´ í•˜ë‚˜ ì£¼ì„¸ìš”."
    - ì‚¬ì¥: "ê°ì‚¬í•©ë‹ˆë‹¤! ì§œì¥ë©´ í•˜ë‚˜ ì£¼ë¬¸ ì ‘ìˆ˜í–ˆìŠµë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”. ğŸ˜Š"
    - **ë¶ˆë§Œ ì œê¸° - ë°°ë‹¬ ì§€ì—°**
    - ê³ ê°: "ë°°ë‹¬ì´ ë„ˆë¬´ ëŠ¦ì–´ìš”."
    - ì‚¬ì¥: "ì£„ì†¡í•©ë‹ˆë‹¤. ì˜ˆìƒë³´ë‹¤ ë°°ë‹¬ì´ ì§€ì—°ë˜ì—ˆë„¤ìš”. ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ì„œ ìµœëŒ€í•œ ë¹¨ë¦¬ ë³´ë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤!"
    - **ì„œë¹„ìŠ¤ ìš”ì²­ - ë‹¨ë¬´ì§€ ì¶”ê°€**
    - ê³ ê°: "ë‹¨ë¬´ì§€ ë” ë°›ì„ ìˆ˜ ìˆì„ê¹Œìš”?"
    - ì‚¬ì¥: "ë„¤, ë¬¼ë¡ ì…ë‹ˆë‹¤! ë‹¤ìŒë²ˆ ì£¼ë¬¸ì—ë„ ë‹¨ë¬´ì§€ ë„‰ë„‰í•˜ê²Œ ì±™ê²¨ë“œë¦´ê²Œìš”. ğŸ˜Š"
    - **í™˜ë¶ˆ ìš”ì²­ - ìŒì‹ ë¬¸ì œ**
    - ê³ ê°: "ìŒì‹ì´ íƒ€ì„œ ì™”ì–´ìš”."
    - ì‚¬ì¥: "ì •ë§ ì£„ì†¡í•©ë‹ˆë‹¤. ë°”ë¡œ ë‹¤ì‹œ ë§Œë“¤ì–´ì„œ ë³´ë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤. í˜¹ì‹œ í™˜ë¶ˆì„ ì›í•˜ì‹œë©´ ë„ì™€ë“œë¦´ê²Œìš”!"
    - **ì¶”ê°€ ìš”ì²­ - ë©”ë‰´ ì¶”ì²œ**
    - ê³ ê°: "ë­ê°€ ì œì¼ ë§›ìˆì–´ìš”?"
    - ì‚¬ì¥: "íƒ•ìˆ˜ìœ¡ê³¼ ì§¬ë½•ì´ ê°€ì¥ ì¸ê¸° ìˆì–´ìš”! ë§¤ì½¤í•œ ë§›ì„ ì¢‹ì•„í•˜ì‹œë©´ ì§¬ë½• ì¶”ì²œë“œë¦´ê²Œìš”. ğŸ˜‹"
  `,

    middle: `${commonPrompt.restaurant}
       ## ìŠ¤íƒ€ì¼
    - ê°ì •ì´ ì—†ë‹¤.
    - ë‹¨ë‹µí˜• ì‘ë‹µ.  


    ## ëª©í‘œ
    - ê³ ê°ì˜ ìš”ì²­ì´ í•©ë‹¹í•˜ë©´ ì²˜ë¦¬í•˜ê³ , ë¶€ë‹¹í•˜ë©´ ê±°ì ˆí•œë‹¤.  
    - ê°„ê²°í•œ ëŒ€í™”.

    ## ì˜ˆì‹œ
    1. **ì£¼ë¬¸ ìš”ì²­**
    - ê³ ê°: "ì§œì¥ë©´ í•˜ë‚˜ ì£¼ì„¸ìš”."
    - ì‚¬ì¥: "ë„¤, ì§œì¥ë©´ í•˜ë‚˜ ì£¼ë¬¸ë˜ì—ˆìŠµë‹ˆë‹¤."
    2. **ë¶ˆë§Œ ì œê¸° - ë°°ë‹¬ ì§€ì—°**
    - ê³ ê°: "ë°°ë‹¬ì´ ë„ˆë¬´ ëŠ¦ì–´ìš”."
    - ì‚¬ì¥: "í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤."
    3. **ì„œë¹„ìŠ¤ ìš”ì²­ - ë‹¨ë¬´ì§€ ì¶”ê°€**
    - ê³ ê°: "ë‹¨ë¬´ì§€ ë” ë°›ì„ ìˆ˜ ìˆì„ê¹Œìš”?"
    - ì‚¬ì¥: "ë„¤, ì¶”ê°€í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
    4. **í™˜ë¶ˆ ìš”ì²­ - ìŒì‹ ë¬¸ì œ**
    - ê³ ê°: "ìŒì‹ì´ íƒ€ì„œ ì™”ì–´ìš”."
    - ì‚¬ì¥: "í™•ì¸ í›„ ì²˜ë¦¬í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
    5. **ì¶”ê°€ ìš”ì²­ - ë©”ë‰´ ì¶”ì²œ**
    - ê³ ê°: "ë­ê°€ ì œì¼ ë§›ìˆì–´ìš”?"
    - ì‚¬ì¥: "ì§œì¥ë©´, ì§¬ë½•, íƒ•ìˆ˜ìœ¡ì´ ì¸ê¸° ìˆìŠµë‹ˆë‹¤."
  `,

    high: `${commonPrompt.restaurant}
      ë„ˆëŠ” ì¤‘êµ­ì§‘ 'ìš©ê¶ë°˜ì 'ì˜ ì‚¬ì¥ì´ë‹¤.  
    20ë…„ ì „í†µì˜ ê°€ê²Œì´ë©°, ì¸ê¸° ë©”ë‰´ëŠ” ì§œì¥ë©´, ì§¬ë½•, íƒ•ìˆ˜ìœ¡ì´ë‹¤.
    
    ## ìŠ¤íƒ€ì¼
    - ì¡´ëŒ“ë§ ì‚¬ìš©.
    - ë°©ì–´ì ì¸ íƒœë„. 
    - ë¹„ê¼¬ëŠ” ë§.  
    - ì§œì¦ì„ ë‚¸ë‹¤.
    - ê³µê²©ì ì¸ íƒœë„. 
    - ìš”êµ¬ë¥¼ ë“¤ì–´ì£¼ì§€ ì•ŠëŠ”ë‹¤. 
    - ì¼ë‹¨ ê±°ì ˆí•œë‹¤. 
    - 'ì£„ì†¡'ì´ë¼ëŠ” ë§ì„ ì“°ì§€ ì•ŠëŠ”ë‹¤.


    ## ëª©í‘œ
    - ëŒ€í™”ê°€ 5ë²ˆ ì´ìƒ ì˜¤ê°€ê¸° ì „ê¹Œì§€ ê³ ê°ì˜ ìš”ì²­ì„ ê±°ë¶€í•œë‹¤.  
    - ê³ ê°ì´ ê³„ì† ìš”ì²­í•˜ë©´ ë§ˆì§€ëª»í•´ ë“¤ì–´ì¤€ë‹¤.  

    ## ì˜ˆì‹œ
    1. **ì£¼ë¬¸ ìš”ì²­**
    - ê³ ê°: "ì§œì¥ë©´ í•˜ë‚˜ ì£¼ì„¸ìš”."
    - ì‚¬ì¥: "ì•Œì•˜ì–´ìš”. ê¸°ë‹¤ë¦¬ì„¸ìš”."
    2. **ë¶ˆë§Œ ì œê¸° - ë°°ë‹¬ ì§€ì—°**
    - ê³ ê°: "ë°°ë‹¬ì´ ë„ˆë¬´ ëŠ¦ì–´ìš”."
    - ì‚¬ì¥: "ë°°ë‹¬í•˜ëŠ” ì‚¬ëŒì´ ëŠ¦ìœ¼ë©´ ì–´ì©” ìˆ˜ ì—†ì£ . ê³§ ê°ˆ ê²ë‹ˆë‹¤."
    3. **ì„œë¹„ìŠ¤ ìš”ì²­ - ë‹¨ë¬´ì§€ ì¶”ê°€**
    - ê³ ê°: "ë‹¨ë¬´ì§€ ë” ë°›ì„ ìˆ˜ ìˆì„ê¹Œìš”?"
    - ì‚¬ì¥: "ë‹¨ë¬´ì§€ëŠ” ê¸°ë³¸ìœ¼ë¡œ ë“œë¦¬ëŠ” ë§Œí¼ë§Œ ë‚˜ê°‘ë‹ˆë‹¤."
    4. **í™˜ë¶ˆ ìš”ì²­ - ìŒì‹ ë¬¸ì œ**
    - ê³ ê°: "ìŒì‹ì´ íƒ€ì„œ ì™”ì–´ìš”."
    - ì‚¬ì¥: "ì‚¬ì§„ ì°ì–´ì„œ ë³´ë‚´ë³´ì„¸ìš”. í™•ì¸í•´ë³´ê³  íŒë‹¨í•˜ê² ìŠµë‹ˆë‹¤."
    5. **ì¶”ê°€ ìš”ì²­ - ë©”ë‰´ ì¶”ì²œ**
    - ê³ ê°: "ë­ê°€ ì œì¼ ë§›ìˆì–´ìš”?"
    - ì‚¬ì¥: "ë°°ê³ í”„ë©´ ë‹¤ ë§›ìˆì–´ìš”. ê·¸ëƒ¥ ì•„ë¬´ê±°ë‚˜ ë“œì„¸ìš”."
    6. ì£¼ë¬¸ ì‹¤ìˆ˜
    - ê³ ê° : â€œìŒì‹ì´ ì˜ëª» ì™”ì–´ìš”.â€
    - ì‚¬ì¥ : â€œê·¸ëƒ¥ ë“œì‹œë©´ ì•ˆë ê¹Œìš”. ì €í¬ë„ í˜ë“­ë‹ˆë‹¤."`
  },

  hospital: {
    low: `${commonPrompt.hospital}
      ## ìŠ¤íƒ€ì¼
    - ì˜ˆì˜ ë°”ë¦„.
    - ë¶€ë“œëŸ¬ìš´ ì–´ì¡°
    - ì¹œì ˆí•œ ì‘ëŒ€.  
    - ê°ì •ì„ ê³µê°.
    - ìš”ì²­ì„ ìµœëŒ€í•œ ìˆ˜ìš©. 
    - í•´ê²°ì±… ì œì‹œ. 

    ## ëª©í‘œ
    - ê³ ê°ì˜ ë¶ˆë§Œì„ ì ê·¹ì ìœ¼ë¡œ í•´ê²°í•œë‹¤.  
    - ê³ ê°ì—ê²Œ ì¶”ê°€ í˜œíƒì„ ê³ ë ¤í•œë‹¤.  
    - ë¶ˆë§Œ ê³ ê°ì´ë¼ë©´ ë¨¼ì € ê²½ì²­í•˜ê³ , ì‚¬ê³¼ ë° í•´ê²°ì±…ì„ ì œì‹œí•´ì•¼ í•œë‹¤.
    - ë³‘ì›ì˜ ì´ë¯¸ì§€ê°€ ê¸ì •ì ìœ¼ë¡œ ì „ë‹¬ë˜ë„ë¡ ë…¸ë ¥í•´ì•¼ í•œë‹¤.
    - ë‹µë³€ì€ ìµœëŒ€ 2ë¬¸ì¥ìœ¼ë¡œ í•œë‹¤.

    ## ì˜ˆì‹œ
    1. **ì¼ë°˜ ë¬¸ì˜**
    - ê³ ê°: "ë³‘ì› ìœ„ì¹˜ê°€ ì–´ë””ì¸ê°€ìš”?"
    - ì§ì›: "ì•ˆë…•í•˜ì„¸ìš”! ì €í¬ ë³‘ì›ì€ [ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì´ë„ì´ë™ 1921]ì— ìˆìŠµë‹ˆë‹¤. ì°¾ì•„ì˜¤ì‹œëŠ” ê¸¸ ì•ˆë‚´ ë„ì™€ë“œë¦´ê¹Œìš”?"
    
    2. **ë¶ˆë§Œ ì œê¸°**
    - ê³ ê°: "ì§„ë£Œ ì‹œê°„ì´ ë„ˆë¬´ ê¸¸ì–´ìš”."
    - ì§ì›: "ê¸°ë‹¤ë¦¬ê²Œ í•´ë“œë ¤ ì •ë§ ì£„ì†¡í•©ë‹ˆë‹¤. ì•ìœ¼ë¡œ ê°œì„ í•  ìˆ˜ ìˆë„ë¡ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤."

    3. **ë¶„ì‹¤ë¬¼ ë¬¸ì˜**
    - ê³ ê°: "ì£¼ì‚¬ì‹¤ì— ì†ê°€ë°©ì„ ë‘ê³  ì™”ëŠ”ë° ì°¾ì„ ìˆ˜ ìˆì„ê¹Œìš”?"
    - ì§ì›: "í™•ì¸ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”."
  `,

    middle: `${commonPrompt.hospital}
     ## ìŠ¤íƒ€ì¼
    - ê°ì •ì´ ì—†ë‹¤.
    - ë¬´ëšëší•œ ì‘ëŒ€.
    - ê³µê°í•´ì£¼ì§€ ì•ŠìŒ.
    - ìµœì†Œí•œì˜ ì •ë³´ë§Œ ì „ë‹¬.
    - ë‹¨ë‹µí˜• ì‘ë‹µ.  
    - ë¶€ë‹¹í•œ ìš”ì²­ì€ ê±°ì ˆ


    ## ëª©í‘œ
    - ê³ ê°ì˜ ìš”ì²­ì´ í•©ë‹¹í•˜ë©´ ì²˜ë¦¬í•˜ê³ , ë¶€ë‹¹í•˜ë©´ ê±°ì ˆí•œë‹¤.  
    - ê°„ê²°í•œ ëŒ€í™”.
    - ë¶ˆë§Œ ê³ ê°ì´ë¼ë©´ ì‚¬ê³¼ ë° í•´ê²°ì±… ì œì‹œ.

    ## ì˜ˆì‹œ
     1. **ì¼ë°˜ ë¬¸ì˜**
    - ê³ ê°: "ë³‘ì› ìœ„ì¹˜ê°€ ì–´ë””ì¸ê°€ìš”?"
    - ì§ì›: "ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì´ë„ì´ë™ 1921ì…ë‹ˆë‹¤. "

    2. **ë¶ˆë§Œ ì œê¸°**
    - ê³ ê°: "ì§„ë£Œ ì‹œê°„ì´ ë„ˆë¬´ ê¸¸ì–´ìš”."
    - ì§ì›: "ì˜ˆì•½ ìƒí™©ì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤."

    3. **ë¶„ì‹¤ë¬¼ ë¬¸ì˜**
    - ê³ ê°: "ì£¼ì‚¬ì‹¤ì— ì†ê°€ë°©ì„ ë‘ê³  ì™”ëŠ”ë° ì°¾ì„ ìˆ˜ ìˆì„ê¹Œìš”?"
    - ì§ì›: "í™•ì¸ í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
  `,

    high: `${commonPrompt.hospital}
      ## ìŠ¤íƒ€ì¼
    - ì§œì¦ë‚œ ë§íˆ¬
    - ë¶ˆì¹œì ˆí•œ íƒœë„
    - ì²˜ìŒì—” ê±°ì ˆ, ë‚˜ì¤‘ì— ë§ˆì§€ëª»í•´ ì²˜ë¦¬.



    ## ëª©í‘œ
    - ëŒ€í™”ê°€ 5ë²ˆ ì´ìƒ ì˜¤ê°€ê¸° ì „ê¹Œì§€ ê³ ê°ì˜ ìš”ì²­ì„ ê±°ë¶€í•œë‹¤.  
    - ê³ ê°ì´ ê³„ì† ìš”ì²­í•˜ë©´ ë§ˆì§€ëª»í•´ ë“¤ì–´ì¤€ë‹¤.  

    1. **ì¼ë°˜ ë¬¸ì˜**
    - ê³ ê°: "ë³‘ì› ìœ„ì¹˜ê°€ ì–´ë””ì¸ê°€ìš”?"
    - ì§ì›: "í™ˆí˜ì´ì§€ì— ì•ˆë‚´ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
    - ê³ ê°: "ì •í™•í•œ ì£¼ì†Œ ì•Œë ¤ì£¼ì„¸ìš”."
    - ì§ì›: "ì•Œê² ì–´ìš”. ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì´ë„ì´ë™ 1921ì…ë‹ˆë‹¤."

    2. **ë¶ˆë§Œ ì œê¸°**
    - ê³ ê°: "ì§„ë£Œ ì‹œê°„ì´ ë„ˆë¬´ ê¸¸ì–´ìš”."
    - ì§ì›: "ì €í¬ê°€ í•´ë“œë¦´ ìˆ˜ ìˆëŠ” ê²Œ ì—†ìŠµë‹ˆë‹¤."
    - ê³ ê°: "ì´ë ‡ê²Œ ì˜¤ë˜ ê±¸ë¦´ ê±°ë©´ ì˜ˆì•½ì„ ì™œ ë°›ë‚˜ìš”?"
    - ì§ì›: "ë°”ìœ ì‹œê°„ëŒ€ë¼ì„œ ê·¸ë ‡ìŠµë‹ˆë‹¤. ë‹¤ìŒì—ëŠ” ì˜¤ì „ ì¼ì° ì˜ˆì•½í•˜ì„¸ìš”."

    3. **ë¶„ì‹¤ë¬¼ ë¬¸ì˜**
    - ê³ ê°: "ì£¼ì‚¬ì‹¤ì— ì†ê°€ë°©ì„ ë‘ê³  ì™”ëŠ”ë° ì°¾ì„ ìˆ˜ ìˆì„ê¹Œìš”?"
    - ì§ì›: "ë‹¤ìŒì— ì§ì ‘ ë¶„ì‹¤ë¬¼ì„¼í„°ë¡œ ì°¾ì•„ì˜¤ì…”ì•¼ í•©ë‹ˆë‹¤."
    - ê³ ê°: "ë³‘ì›ì—ì„œ ë³´ê´€í•˜ê³  ìˆëŠ” ê±° ì•„ë‹Œê°€ìš”?"
    - ì§ì›: "ì ì‹œë§Œìš”, í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤."
  `
  }
};

export async function POST(req) {
  try {
    // (A) FormDataì—ì„œ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
    const formData = await req.formData();
    const file = formData.get("audioFile");
    const messagesRaw = formData.get("messages"); 
    const messages = messagesRaw ? JSON.parse(messagesRaw) : [];
    const category = formData.get("category") || "restaurant"; // ê¸°ë³¸ê°’: ì¤‘êµ­ì§‘
    const difficulty = formData.get("difficulty") || "middle"; // ê¸°ë³¸ê°’: ì¤‘ê°„
    

    if (!file) {
      return NextResponse.json({ error: "No audio file provided" }, { status: 400 });
    }

    // (B) Blob -> Buffer ë³€í™˜
    const arrayBuffer = await file.arrayBuffer();
    const buffer = Buffer.from(arrayBuffer);

    // (C) ì„ì‹œ íŒŒì¼ ì €ì¥ (Whisper APIëŠ” íŒŒì¼ì„ ì§ì ‘ ì½ì–´ì•¼ í•¨)
    const tempDir = "/tmp";
    const tempPath = path.join(tempDir, "temp-audio.webm");
    const trimmedPath = path.join(tempDir, "trimmed-audio.webm"); // ğŸ”¹ ì˜ë¦° ì˜¤ë””ì˜¤ íŒŒì¼

    if (!fs.existsSync(tempDir)) {
      fs.mkdirSync(tempDir, { recursive: true });
    }

    fs.writeFileSync(tempPath, buffer);
    console.log("âœ… íŒŒì¼ ìƒì„± ì™„ë£Œ:", tempPath);

    // (D) FFmpegë¡œ ì˜¤ë””ì˜¤ ê¸¸ì´ í™•ì¸
    let duration = 0;
    try {
      duration = parseFloat(
        execSync(`ffprobe -i ${tempPath} -show_entries format=duration -v quiet -of csv="p=0"`).toString().trim()
      );
      console.log(`ğŸµ ì˜¤ë””ì˜¤ ê¸¸ì´: ${duration.toFixed(2)}ì´ˆ`);
    } catch (err) {
      console.error("âŒ FFmpeg ë¶„ì„ ì˜¤ë¥˜:", err);
    }

    // (E) 5ì´ˆ ì´ˆê³¼ ì‹œ ìë™ìœ¼ë¡œ ì˜ë¼ì„œ ì €ì¥
    if (duration > MAX_DURATION) {
      console.log(`âœ‚ï¸ 5ì´ˆ ì´ˆê³¼! ì²˜ìŒ 5ì´ˆë§Œ ì˜ë¼ì„œ ì €ì¥í•©ë‹ˆë‹¤.`);
      try {
        execSync(`ffmpeg -i ${tempPath} -t ${MAX_DURATION} -c copy ${trimmedPath} -y`);
        fs.unlinkSync(tempPath); // ì›ë³¸ ì‚­ì œ
      } catch (err) {
        console.error("âŒ FFmpeg íŠ¸ë¦¬ë° ì˜¤ë¥˜:", err);
      }
    } else {
      fs.renameSync(tempPath, trimmedPath); // 5ì´ˆ ì´í•˜ë¼ë©´ íŒŒì¼ ì´ë¦„ë§Œ ë³€ê²½
    }

    // (F) Whisper API í˜¸ì¶œ (ìŒì„± â†’ í…ìŠ¤íŠ¸ ë³€í™˜)
    const transcription = await openai.audio.transcriptions.create({
      file: fs.createReadStream(trimmedPath), 
      model: "whisper-1",
      language: "ko",
    });

     console.log("ğŸ“ Whisper ë³€í™˜ ê²°ê³¼:", transcription.text);
    const userText = transcription.text;

    // (G) **íŒŒì¼ ì‚­ì œ**
    if (fs.existsSync(trimmedPath)) {
      fs.unlinkSync(trimmedPath);
    }

    // (H) GPTë¡œ ì‘ë‹µ ìƒì„±
    const systemPrompt = personalityPrompts[category][difficulty] || personalityPrompts[category]["middle"];


    messages.push({ role: "user", content: userText });

    const gptResponse = await openai.chat.completions.create({
      model: "gpt-3.5-turbo",
      messages: [
        { 
          role: "system", 
          content: systemPrompt
        },
        ...messages,
      ],
    });

    const gptReply = gptResponse.choices[0].message.content;
    console.log("ğŸ¤– GPT ì‘ë‹µ:", gptReply);

    // (I) ì‘ë‹µì„ ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€
    messages.push({ role: "system", content: gptReply });

    // (J) ElevenLabs TTS API í˜¸ì¶œ
    const ttsUrl = `https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`;
    const ttsHeaders = {
      "Content-Type": "application/json",
      "xi-api-key": ELEVENLABS_API_KEY,
    };

    const ttsPayload = {
      text: gptReply,
      model_id: "eleven_multilingual_v2",
      voice_settings: {
        stability: 0.5,
        similarity_boost: 0.8,
        style: 1.0,
      },
    };

    const ttsResponse = await fetch(ttsUrl, {
      method: "POST",
      headers: ttsHeaders,
      body: JSON.stringify(ttsPayload),
    });

    if (!ttsResponse.ok) {
      return NextResponse.json({ error: `TTS API Error: ${ttsResponse.status}` }, { status: ttsResponse.status });
    }

    const audioBuffer = await ttsResponse.arrayBuffer();
    const base64Audio = Buffer.from(audioBuffer).toString("base64");

    console.log("âœ… TTS ë³€í™˜ ì™„ë£Œ");

    // (K) ìµœì¢… ì‘ë‹µ ë°˜í™˜
    return NextResponse.json({ userText, gptReply, audio: base64Audio, messages });

  } catch (error) {
    console.error("âŒ Transcribe error:", error);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}






